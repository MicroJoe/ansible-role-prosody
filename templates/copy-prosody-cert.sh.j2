#!/bin/sh

# This hook is called after a new certificate has been generated by certbot.
# It has to be installed in /etc/letsencrypt/renewal-hooks

set -eu

PROSODY_DOMAIN={{ prosody_domain }}
DESTDIR={{ prosody_cert_dir }}

install_file() {
	install -m640 -o root -g prosody "$1" "$2"
}

for domain in $RENEWED_DOMAINS; do
	if [ "$domain" = "$PROSODY_DOMAIN" ]; then
		PRIVKEY="$RENEWED_LINEAGE/privkey.pem"
		FULLCHAIN="$RENEWED_LINEAGE/fullchain.pem"

		install_file "$FULLCHAIN" "$DESTDIR/$PROSODY_DOMAIN.crt"
		install_file "$PRIVKEY" "$DESTDIR/$PROSODY_DOMAIN.key"
	fi
done
